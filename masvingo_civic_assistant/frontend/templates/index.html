    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Masvingo Civic Assistant - Multi-Agent System</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="/static/css/main.css">
        <link rel="manifest" href="/static/manifest.json">
        <meta name="theme-color" content="#2563eb">
        <style>
            @keyframes slide-in-right {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slide-out-right {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .animate-slide-in-right {
                animation: slide-in-right 0.3s ease-out;
            }
            .animate-slide-out-right {
                animation: slide-out-right 0.3s ease-in;
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
        <div class="container mx-auto px-4 py-8 max-w-6xl">

            <!-- Header -->
            <header class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-city text-4xl text-blue-600 mr-3"></i>
                    <h1 class="text-3xl font-bold text-gray-800">Masvingo City Council</h1>
                </div>
                <h2 class="text-xl font-semibold text-blue-700 mb-2">Multi-Agent Civic Assistant</h2>
                <p class="text-gray-600">Intelligent orchestration of specialized agents for all your civic needs</p>
            </header>

            <!-- Notification System -->
            <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
            <div class="grid md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <i class="fas fa-calculator text-blue-500 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Billing Agent</h3>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 text-xs" id="billing-status"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">Check water bills, payments, and account balances</p>
                    <div class="mt-2 text-xs text-gray-500" id="billing-metrics">Response time: ~2s</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-red-500">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Incident Agent</h3>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 text-xs" id="incident-status"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">Report pipe bursts, maintenance issues, and emergencies</p>
                    <div class="mt-2 text-xs text-gray-500" id="incident-metrics">Response time: ~3s</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <i class="fas fa-file-signature text-green-500 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Licensing Agent</h3>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 text-xs" id="licensing-status"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">Apply for business licences and permits</p>
                    <div class="mt-2 text-xs text-gray-500" id="licensing-metrics">Response time: ~5s</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <i class="fas fa-robot text-purple-500 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">General Assistant</h3>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 text-xs" id="general-status"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">General council information and web-enhanced search</p>
                    <div class="mt-2 text-xs text-gray-500" id="general-metrics">Response time: ~4s</div>
                </div>
            </div>

            <!-- Quick Actions Bar -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                    Quick Actions
                </h4>
                <div class="flex flex-wrap gap-2">
                    <button class="quick-action-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-full text-sm transition" data-query="What's my current water bill balance?">
                        <i class="fas fa-calculator mr-1"></i> Check Bill
                    </button>
                    <button class="quick-action-btn bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-full text-sm transition" data-query="I have a burst water pipe on Main Street">
                        <i class="fas fa-exclamation-triangle mr-1"></i> Report Incident
                    </button>
                    <button class="quick-action-btn bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-full text-sm transition" data-query="I want to apply for a business license">
                        <i class="fas fa-file-signature mr-1"></i> Apply for License
                    </button>
                    <button class="quick-action-btn bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded-full text-sm transition" data-query="What are the council office hours?">
                        <i class="fas fa-clock mr-1"></i> Office Hours
                    </button>
                    <button class="quick-action-btn bg-gray-100 hover:bg-gray-700 text-gray-700 px-3 py-2 rounded-full text-sm transition" data-query="How do I contact the council?">
                        <i class="fas fa-phone mr-1"></i> Contact Info
                    </button>
                </div>
            </div>

            <!-- Main Chat Interface -->
            <div class="bg-white rounded-xl shadow-xl overflow-hidden mb-6">

                <!-- Chat Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold flex items-center">
                                <i class="fas fa-robot mr-2"></i>
                                AI Assistant Chat
                            </h3>
                            <p class="text-sm opacity-90">Powered by LangGraph orchestration</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/10 transition" title="Toggle theme">
                                <i class="fas fa-moon"></i>
                            </button>
                            <button id="export-chat" class="p-2 rounded-full hover:bg-white/10 transition" title="Export conversation">
                                <i class="fas fa-download"></i>
                            </button>
                            <button id="clear-chat" class="p-2 rounded-full hover:bg-white/10 transition" title="Clear chat">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Bar -->
                <div id="status-bar" class="bg-gray-50 px-4 py-2 text-sm text-gray-600 border-b flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-circle text-green-500 mr-1" id="system-status"></i>
                        <span id="status-text">System ready - Ask any civic-related question</span>
                    </div>
                    <div class="text-xs text-gray-500" id="response-time"></div>
                </div>

                <!-- Chat History -->
                <div id="chat-history" class="h-96 overflow-y-auto p-4 space-y-4">
                    <!-- Welcome message -->
                    <div class="flex justify-start">
                        <div class="bg-gray-100 rounded-lg p-3 max-w-xs lg:max-w-md">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                <span class="font-semibold text-blue-700">System</span>
                            </div>
                            <p class="text-gray-700">Welcome to the Masvingo Civic Assistant! I can help you with billing inquiries, incident reporting, licence applications, and general council information. What can I assist you with today?</p>
                            <div class="flex flex-wrap gap-1 mt-3">
                                <button class="suggestion-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs transition">Check my water bill</button>
                                <button class="suggestion-btn bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-xs transition">Report a pipe burst</button>
                                <button class="suggestion-btn bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded text-xs transition">Apply for license</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" class="hidden px-4 py-2 bg-gray-50 border-t">
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span class="text-sm text-gray-600" id="typing-text">Analyzing your question...</span>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="error" class="text-red-600 font-medium px-4 py-2 bg-red-50 border-t hidden" role="alert" aria-live="assertive">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="error-text"></span>
                </div>

                <!-- Input Form -->
                <form id="query-form" class="bg-gray-50 p-4 border-t">
                    <div class="flex space-x-2">
                        <div class="flex-1 relative">
                            <textarea id="question" name="question" rows="2" placeholder="Ask about billing, report an incident, apply for a licence, or ask general questions..." class="w-full p-3 border rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                            <div class="absolute bottom-2 right-2 text-xs text-gray-400" id="char-count">0/500</div>
                        </div>
                        <div class="flex flex-col justify-end space-y-2">
                            <button type="submit" id="send-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-paper-plane mr-2"></i>
                                <span id="send-text">Send</span>
                            </button>
                            <div class="flex space-x-1">
                                <button type="button" id="voice-btn" class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition duration-200" title="Voice input">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <label for="file-input" class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition duration-200 cursor-pointer" title="Attach file">
                                    <i class="fas fa-paperclip"></i>
                                </label>
                                <input type="file" id="file-input" class="hidden" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                        <div class="flex items-center space-x-4">
                            <span>Press <kbd class="bg-gray-200 px-1 rounded">Enter</kbd> to send, <kbd class="bg-gray-200 px-1 rounded">Shift+Enter</kbd> for new line</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="button" id="preview-btn" class="text-blue-600 hover:underline">Preview</button>
                            <button type="button" id="clear-btn" class="text-gray-600 hover:underline">Clear</button>
                        </div>
                    </div>
                </form>

                <!-- Preview Modal -->
                <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Message Preview</h3>
                                <button id="close-preview" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="preview-content" class="prose max-w-none"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="text-center mt-8 text-gray-500 text-sm">
                <p>&copy; 2026 Masvingo City Council - Multi-Agent Civic Assistant System</p>
                <p class="mt-1">Built with LangGraph, LangChain, and specialized AI agents</p>
            </footer>
        </div>

        <script>
            // Global variables and state
            let isDarkMode = false;
            let conversationHistory = [];
            let attachedFiles = [];
            let agentMetrics = {
                billing: { responseTime: '~2s', queries: 0 },
                incident: { responseTime: '~3s', queries: 0 },
                licensing: { responseTime: '~5s', queries: 0 },
                general: { responseTime: '~4s', queries: 0 }
            };

            // DOM elements
            const form = document.getElementById("query-form");
            const questionInput = document.getElementById("question");
            const chatHistoryDiv = document.getElementById("chat-history");
            const errorDiv = document.getElementById("error");
            const statusBar = document.getElementById("status-bar");
            const typingIndicator = document.getElementById("typing-indicator");
            const charCount = document.getElementById("char-count");
            const sendBtn = document.getElementById("send-btn");
            const previewModal = document.getElementById("preview-modal");
            const previewContent = document.getElementById("preview-content");

            // Agent information
            const agentInfo = {
                billing: { name: "Billing Agent", icon: "fas fa-calculator", color: "blue" },
                incident: { name: "Incident Agent", icon: "fas fa-exclamation-triangle", color: "red" },
                licensing: { name: "Licensing Agent", icon: "fas fa-file-signature", color: "green" },
                unknown: { name: "General Assistant", icon: "fas fa-robot", color: "purple" }
            };

            // Initialize application
            document.addEventListener('DOMContentLoaded', function() {
                setupEventListeners();
                loadSavedTheme();
                updateAgentMetrics();
                registerServiceWorker();
            });

            function setupEventListeners() {
                // Form submission
                form.addEventListener("submit", handleFormSubmit);

                // Input handling
                questionInput.addEventListener("input", handleInput);
                questionInput.addEventListener("keydown", handleKeyDown);

                // Button handlers
                document.getElementById("theme-toggle").addEventListener("click", toggleTheme);
                document.getElementById("export-chat").addEventListener("click", exportChat);
                document.getElementById("clear-chat").addEventListener("click", clearChat);
                document.getElementById("preview-btn").addEventListener("click", showPreview);
                document.getElementById("close-preview").addEventListener("click", hidePreview);
                document.getElementById("clear-btn").addEventListener("click", () => {
                    questionInput.value = "";
                    updateCharCount();
                });

                // Quick actions
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        questionInput.value = btn.dataset.query;
                        updateCharCount();
                        questionInput.focus();
                    });
                });

                // Suggestion buttons
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('suggestion-btn')) {
                        questionInput.value = e.target.textContent;
                        updateCharCount();
                        questionInput.focus();
                    }
                });

                // Voice input functionality
                let recognition = null;
                let isListening = false;

                // Initialize speech recognition
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';

                    recognition.onstart = function() {
                        isListening = true;
                        updateVoiceButton(true);
                        updateStatus("Listening...", "blue");
                    };

                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        questionInput.value += (questionInput.value ? ' ' : '') + transcript;
                        updateCharCount();
                        questionInput.focus();
                    };

                    recognition.onerror = function(event) {
                        console.error('Speech recognition error:', event.error);
                        showError('Voice recognition error: ' + event.error);
                        updateVoiceButton(false);
                        updateStatus("Voice recognition failed", "red");
                    };

                    recognition.onend = function() {
                        isListening = false;
                        updateVoiceButton(false);
                        updateStatus("Voice input ready", "green");
                    };
                }

                // Voice input handler
                document.getElementById("voice-btn").addEventListener("click", () => {
                    if (!recognition) {
                        showError("Voice input is not supported in your browser. Please use Chrome, Edge, or Safari.");
                        return;
                    }

                    if (isListening) {
                        recognition.stop();
                    } else {
                        recognition.start();
                    }
                });

                function updateVoiceButton(listening) {
                    const voiceBtn = document.getElementById("voice-btn");
                    const icon = voiceBtn.querySelector("i");

                    if (listening) {
                        voiceBtn.className = "bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-200 animate-pulse";
                        icon.className = "fas fa-stop-circle";
                        voiceBtn.title = "Stop listening";
                    } else {
                        voiceBtn.className = "bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition duration-200";
                        icon.className = "fas fa-microphone";
                        voiceBtn.title = "Voice input";
                    }
                }

                // File upload functionality
                document.getElementById("file-input").addEventListener("change", handleFileSelect);

                function handleFileSelect(event) {
                    const files = Array.from(event.target.files);

                    files.forEach(file => {
                        if (validateFile(file)) {
                            attachedFiles.push(file);
                            displayFileAttachment(file);
                        }
                    });

                    // Clear input
                    event.target.value = '';
                }

                function validateFile(file) {
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    const allowedTypes = ['text/plain', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/jpg', 'image/png'];

                    if (file.size > maxSize) {
                        showError(`File ${file.name} is too large. Maximum size is 10MB.`);
                        return false;
                    }

                    if (!allowedTypes.includes(file.type)) {
                        showError(`File type ${file.type} is not supported. Supported types: TXT, PDF, DOC, DOCX, JPG, PNG.`);
                        return false;
                    }

                    return true;
                }

                function displayFileAttachment(file) {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.className = 'file-attachment bg-blue-50 border border-blue-200 rounded-lg p-2 mt-2 flex items-center justify-between';
                    attachmentDiv.dataset.fileName = file.name;

                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'flex items-center';
                    fileInfo.innerHTML = `
                        <i class="fas fa-file text-blue-500 mr-2"></i>
                        <div>
                            <div class="text-sm font-medium text-blue-700">${file.name}</div>
                            <div class="text-xs text-blue-500">${formatFileSize(file.size)}</div>
                        </div>
                    `;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'text-red-500 hover:text-red-700 ml-2';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = () => removeFileAttachment(file.name, attachmentDiv);

                    attachmentDiv.appendChild(fileInfo);
                    attachmentDiv.appendChild(removeBtn);

                    // Insert before the input form controls
                    const formContainer = document.querySelector('#query-form .flex');
                    formContainer.parentNode.insertBefore(attachmentDiv, formContainer);

                    // Show notification
                    showNotification(`File "${file.name}" attached successfully`, "success");
                }

                function removeFileAttachment(fileName, element) {
                    attachedFiles = attachedFiles.filter(file => file.name !== fileName);
                    element.remove();
                }

                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                // Request notification permission
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                // Service Worker registration for PWA
                // Moved to global scope below
            }

            // Service Worker registration for PWA (moved to global scope)
            function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/static/sw.js')
                        .then(registration => {
                            console.log('Service Worker registered successfully:', registration);

                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showNotification('App updated! Refresh to get the latest version.', 'info', 10000);
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
            }

            // Notification system (moved to global scope)
            function showNotification(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification p-4 rounded-lg shadow-lg max-w-sm animate-slide-in-right ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;

                const icon = type === 'success' ? 'fas fa-check-circle' :
                           type === 'error' ? 'fas fa-exclamation-circle' :
                           type === 'warning' ? 'fas fa-exclamation-triangle' :
                           'fas fa-info-circle';

                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="${icon} mr-2"></i>
                        <span class="flex-1">${message}</span>
                        <button class="ml-2 text-white/70 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                document.getElementById('notification-container').appendChild(notification);

                // Auto remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.classList.add('animate-slide-out-right');
                            setTimeout(() => notification.remove(), 300);
                        }
                    }, duration);
                }

                return notification;
            }

            function showBrowserNotification(title, body, icon = '/static/favicon.ico') {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body, icon });
                }
            }

            function handleInput() {
                updateCharCount();
                hideError();
            }

            function handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            }

            function updateCharCount() {
                const count = questionInput.value.length;
                charCount.textContent = `${count}/500`;
                charCount.className = count > 450 ? "absolute bottom-2 right-2 text-xs text-red-400" : "absolute bottom-2 right-2 text-xs text-gray-400";
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                hideError();

                const userMessage = questionInput.value.trim();
                if (!userMessage && attachedFiles.length === 0) return;

                // Disable form during processing
                setFormDisabled(true);
                questionInput.value = "";

                // Add user message with attachments
                addMessageWithAttachments("user", userMessage, attachedFiles);
                conversationHistory.push({
                    role: "user",
                    content: userMessage,
                    attachments: attachedFiles.map(f => ({ name: f.name, size: f.size, type: f.type }))
                });

                // Clear attachments
                document.querySelectorAll('.file-attachment').forEach(el => el.remove());
                const filesToProcess = [...attachedFiles];
                attachedFiles = [];

                // Show typing indicator
                showTypingIndicator("Analyzing your question...");

                const startTime = Date.now();

                try {
                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('question', userMessage);
                    filesToProcess.forEach(file => {
                        formData.append('files', file);
                    });

                    console.log('Sending request to /agent-query...');
                    // Send to agent query endpoint
                    const response = await fetch("/agent-query", {
                        method: "POST",
                        body: formData
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);
                    const responseTime = Date.now() - startTime;

                    hideTypingIndicator();

                    if (data.error) {
                        console.log('Server returned error:', data.error);
                        showError(data.error);
                        updateStatus("Error occurred", "red");
                        showNotification("Failed to process your request", "error");
                    } else {
                        console.log('Processing successful response...');
                        // Add agent response with metadata
                        try {
                            addAgentMessage(data.answer || data.response, data.agent_used || "unknown", data.classification || "unknown");
                            updateStatus("Response received", "green");
                            updateResponseTime(responseTime);

                            conversationHistory.push({ role: "assistant", content: data.answer || data.response });

                            // Show success notification
                            showNotification("Response received successfully", "success");
                            showBrowserNotification("Masvingo Civic Assistant", "Your query has been processed");
                            console.log('Response processing completed successfully');
                        } catch (processingError) {
                            console.error('Error processing response:', processingError);
                            showError("Error processing response: " + processingError.message);
                            updateStatus("Processing error", "red");
                        }
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    hideTypingIndicator();
                    showError("Error connecting to server: " + error.message);
                    updateStatus("Connection error", "red");
                }

                // Re-enable form
                setFormDisabled(false);
                updateCharCount();
            }

            function setFormDisabled(disabled) {
                sendBtn.disabled = disabled;
                questionInput.disabled = disabled;
                sendBtn.innerHTML = disabled ?
                    '<i class="fas fa-spinner fa-spin mr-2"></i><span id="send-text">Processing</span>' :
                    '<i class="fas fa-paper-plane mr-2"></i><span id="send-text">Send</span>';
            }

            function showTypingIndicator(message = "Processing...") {
                document.getElementById("typing-text").textContent = message;
                typingIndicator.classList.remove("hidden");
            }

            function hideTypingIndicator() {
                typingIndicator.classList.add("hidden");
            }

            function showError(message) {
                document.getElementById("error-text").textContent = message;
                errorDiv.classList.remove("hidden");
            }

            function hideError() {
                errorDiv.classList.add("hidden");
            }

            function updateStatus(message, color) {
                const statusText = document.getElementById("status-text");
                const systemStatus = document.getElementById("system-status");

                statusText.textContent = message;
                systemStatus.className = `fas fa-circle text-${color === 'green' ? 'green' : color === 'yellow' ? 'yellow' : 'red'}-500 mr-1`;
            }

            function updateResponseTime(timeMs) {
                const timeText = timeMs < 1000 ? `${timeMs}ms` : `${(timeMs/1000).toFixed(1)}s`;
                document.getElementById("response-time").textContent = `Response: ${timeText}`;
            }

            function updateAgentMetrics() {
                // Update metrics display (placeholder for real metrics)
                Object.keys(agentMetrics).forEach(agent => {
                    const metricsDiv = document.getElementById(`${agent}-metrics`);
                    if (metricsDiv) {
                        metricsDiv.textContent = `Response time: ${agentMetrics[agent].responseTime}`;
                    }
                });
            }

            function toggleTheme() {
                isDarkMode = !isDarkMode;
                document.documentElement.classList.toggle('dark', isDarkMode);
                const themeIcon = document.querySelector("#theme-toggle i");
                themeIcon.className = isDarkMode ? "fas fa-sun" : "fas fa-moon";
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            }

            function loadSavedTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    isDarkMode = true;
                    document.documentElement.classList.add('dark');
                    document.querySelector("#theme-toggle i").className = "fas fa-sun";
                }
            }

            function exportChat() {
                const chatContent = conversationHistory.map(msg =>
                    `${msg.role.toUpperCase()}: ${msg.content}`
                ).join('\n\n');

                const blob = new Blob([chatContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `civic-assistant-chat-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function clearChat() {
                if (confirm('Are you sure you want to clear the chat history?')) {
                    chatHistoryDiv.innerHTML = '';
                    conversationHistory = [];
                    updateStatus("Chat cleared", "gray");
                }
            }

            function showPreview() {
                const content = questionInput.value.trim();
                if (content) {
                    previewContent.innerHTML = marked.parse(content);
                    previewModal.classList.remove("hidden");
                }
            }

            function hidePreview() {
                previewModal.classList.add("hidden");
            }

            // Message rendering functions
            function addMessage(sender, message) {
                const timestamp = new Date().toLocaleTimeString();
                const wrapper = document.createElement("div");
                wrapper.className = "flex items-start gap-3 " + (sender === "user" ? "justify-end" : "justify-start");

                const avatar = document.createElement("img");
                avatar.src = sender === "user"
                    ? "https://ui-avatars.com/api/?name=You&background=0D8ABC&color=fff"
                    : "https://ui-avatars.com/api/?name=Assistant&background=gray&color=fff";
                avatar.alt = sender;
                avatar.className = "w-8 h-8 rounded-full";

                const bubble = document.createElement("div");
                bubble.className = `max-w-sm lg:max-w-md px-4 py-2 rounded-2xl shadow ${
                    sender === "user" ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-800"
                }`;
                bubble.innerHTML = `<p class="text-sm">${marked.parse(message)}</p><p class="text-xs text-right mt-1 opacity-60">${timestamp}</p>`;

                if (sender === "user") {
                    wrapper.appendChild(bubble);
                    wrapper.appendChild(avatar);
                } else {
                    wrapper.appendChild(avatar);
                    wrapper.appendChild(bubble);
                }

                chatHistoryDiv.appendChild(wrapper);
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            }

            function addMessageWithAttachments(sender, message, attachments) {
                const timestamp = new Date().toLocaleTimeString();
                const wrapper = document.createElement("div");
                wrapper.className = "flex items-start gap-3 " + (sender === "user" ? "justify-end" : "justify-start");

                const avatar = document.createElement("img");
                avatar.src = sender === "user"
                    ? "https://ui-avatars.com/api/?name=You&background=0D8ABC&color=fff"
                    : "https://ui-avatars.com/api/?name=Assistant&background=gray&color=fff";
                avatar.alt = sender;
                avatar.className = "w-8 h-8 rounded-full";

                const bubble = document.createElement("div");
                bubble.className = `max-w-sm lg:max-w-md px-4 py-2 rounded-2xl shadow ${
                    sender === "user" ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-800"
                }`;

                let content = '';
                if (message) {
                    try {
                        content += `<p class="text-sm">${marked.parse(message)}</p>`;
                    } catch (parseError) {
                        console.warn('Markdown parsing failed for user message, using plain text:', parseError);
                        content += `<p class="text-sm">${message.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
                    }
                }

                if (attachments && attachments.length > 0) {
                    content += '<div class="mt-2 space-y-1">';
                    attachments.forEach(file => {
                        const icon = getFileIcon(file.type);
                        content += `
                            <div class="flex items-center text-xs ${sender === "user" ? "text-blue-100" : "text-gray-600"}">
                                <i class="${icon} mr-1"></i>
                                <span class="truncate">${file.name}</span>
                                <span class="ml-1">(${formatFileSize(file.size)})</span>
                            </div>
                        `;
                    });
                    content += '</div>';
                }

                content += `<p class="text-xs text-right mt-1 opacity-60">${timestamp}</p>`;
                bubble.innerHTML = content;

                if (sender === "user") {
                    wrapper.appendChild(bubble);
                    wrapper.appendChild(avatar);
                } else {
                    wrapper.appendChild(avatar);
                    wrapper.appendChild(bubble);
                }

                chatHistoryDiv.appendChild(wrapper);
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            }

            function getFileIcon(mimeType) {
                if (mimeType.startsWith('image/')) return 'fas fa-image';
                if (mimeType === 'application/pdf') return 'fas fa-file-pdf';
                if (mimeType.includes('word') || mimeType.includes('document')) return 'fas fa-file-word';
                return 'fas fa-file';
            }

            function addAgentMessage(message, agentType = "unknown", classification = "unknown") {
                const timestamp = new Date().toLocaleTimeString();
                const agent = agentInfo[agentType] || agentInfo.unknown;

                if (!agent) {
                    console.error('Agent info not found for type:', agentType);
                    return;
                }

                const wrapper = document.createElement("div");
                wrapper.className = "flex items-start gap-3 justify-start";

                const avatar = document.createElement("div");
                avatar.className = `w-8 h-8 rounded-full bg-${agent.color}-100 flex items-center justify-center`;
                avatar.innerHTML = `<i class="${agent.icon} text-${agent.color}-600"></i>`;

                const bubble = document.createElement("div");
                bubble.className = "max-w-sm lg:max-w-md bg-white border rounded-2xl shadow p-4";

                // Agent header with classification info
                const header = document.createElement("div");
                header.className = `flex items-center justify-between mb-2 pb-2 border-b border-${agent.color}-200`;
                header.innerHTML = `
                    <div class="flex items-center">
                        <i class="${agent.icon} text-${agent.color}-500 mr-2"></i>
                        <span class="font-semibold text-${agent.color}-700">${agent.name}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-gray-500">${timestamp}</span>
                        <div class="text-xs text-gray-400">Query classified as: ${classification}</div>
                    </div>
                `;

                const content = document.createElement("div");
                content.className = "text-sm text-gray-800";
                try {
                    content.innerHTML = marked.parse(message);
                } catch (parseError) {
                    console.warn('Markdown parsing failed, using plain text:', parseError);
                    content.textContent = message; // Fallback to plain text
                }

                // Add feedback buttons
                const feedback = document.createElement("div");
                feedback.className = "flex items-center justify-end mt-2 space-x-1";
                feedback.innerHTML = `
                    <button class="text-xs text-gray-400 hover:text-green-500 transition" title="Helpful">
                        <i class="fas fa-thumbs-up"></i>
                    </button>
                    <button class="text-xs text-gray-400 hover:text-red-500 transition" title="Not helpful">
                        <i class="fas fa-thumbs-down"></i>
                    </button>
                `;

                bubble.appendChild(header);
                bubble.appendChild(content);
                bubble.appendChild(feedback);

                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);

                chatHistoryDiv.appendChild(wrapper);
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            }
        </script>
    </html>
