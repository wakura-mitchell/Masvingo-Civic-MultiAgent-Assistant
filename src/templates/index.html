<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Masvingo City Council RAG Assistant</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	</head>
	<body
		class="bg-gray-50 min-h-screen flex flex-col items-center justify-center"
	>
		<div
			class="w-full max-w-4xl p-4 sm:p-8 bg-white rounded-lg shadow flex flex-col h-[90vh]"
		>
			<!-- Header -->
			<header class="text-center mb-4">
				<h1 class="text-2xl font-bold text-blue-700">
					Masvingo City Council RAG Assistant
				</h1>
				<p class="text-sm text-gray-600">
					Ask questions about council documents and get instant
					answers.
				</p>
			</header>

			<!-- Chat History -->
			<div
				id="chat-history"
				class="flex-1 overflow-y-auto p-4 bg-gray-50 rounded-lg mb-4 space-y-4"
			>
				<!-- Messages will be injected here -->
			</div>

			<!-- Error Message -->
			<div
				id="error"
				class="text-red-600 font-medium mb-2"
				role="alert"
				aria-live="assertive"
			></div>

			<!-- Upload Form -->
			<form id="upload-form" class="mb-4">
				<label
					for="file"
					class="block text-sm font-semibold text-gray-700 mb-2"
					>Upload a new document (.txt):</label
				>
				<input
					type="file"
					id="file"
					name="file"
					accept=".txt"
					class="w-full mb-2 border rounded p-2"
					required
				/>
				<button
					type="submit"
					class="w-full py-2 px-4 bg-green-600 text-white rounded hover:bg-green-700 transition"
				>
					Upload
				</button>
				<div
					id="upload-status"
					class="mt-2 text-green-700 font-medium"
				></div>
			</form>

			<!-- Sticky Input Form -->
			<form
				id="query-form"
				class="sticky bottom-0 bg-white p-4 shadow-md rounded-lg"
			>
				<textarea
					id="question"
					name="question"
					rows="3"
					placeholder="Ask a question..."
					class="w-full p-3 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
					required
				></textarea>
				<div class="flex justify-between items-center mt-2">
					<button
						type="submit"
						class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
					>
						Ask
					</button>
					<button
						type="button"
						id="previewBtn"
						class="text-sm text-blue-600 hover:underline"
					>
						Preview Markdown
					</button>
				</div>
				<div
					id="previewArea"
					class="mt-2 p-2 bg-gray-100 rounded hidden"
				></div>
			</form>
		</div>

		<script>
			const form = document.getElementById("query-form");
			const questionInput = document.getElementById("question");
			const chatHistoryDiv = document.getElementById("chat-history");
			const errorDiv = document.getElementById("error");
			const uploadForm = document.getElementById("upload-form");
			const fileInput = document.getElementById("file");
			const uploadStatus = document.getElementById("upload-status");
			const previewBtn = document.getElementById("previewBtn");
			const previewArea = document.getElementById("previewArea");

			// Markdown Preview
			previewBtn.addEventListener("click", () => {
				previewArea.innerHTML = marked.parse(questionInput.value);
				previewArea.classList.toggle("hidden");
			});

			// Clear error on input
			questionInput.addEventListener("input", () => {
				errorDiv.textContent = "";
			});

			// Upload logic
			uploadForm.addEventListener("submit", async (e) => {
				e.preventDefault();
				uploadStatus.textContent = "";
				errorDiv.textContent = "";
				const formData = new FormData(uploadForm);
				try {
					const response = await fetch("/upload", {
						method: "POST",
						body: formData,
					});
					const data = await response.json();
					if (data.success) {
						uploadStatus.textContent = `✅ Uploaded: ${data.filename}`;
						fileInput.value = "";
					} else {
						errorDiv.textContent = `❌ ${
							data.error || "Unexpected response."
						}`;
					}
				} catch {
					errorDiv.textContent = "❌ Error uploading file.";
				}
			});

			// Ask logic
			form.addEventListener("submit", async (e) => {
				e.preventDefault();
				errorDiv.textContent = "";
				const formData = new FormData(form);
				const userMessage = questionInput.value.trim();
				if (userMessage) {
					addMessage("user", userMessage);
					questionInput.value = "";
					previewArea.classList.add("hidden");
				}
				try {
					const response = await fetch("/query", {
						method: "POST",
						body: formData,
					});
					const data = await response.json();
					if (data.history) {
						renderChatHistory(data.history);
					} else if (data.answer) {
						addMessage("assistant", data.answer);
					} else {
						errorDiv.textContent = `❌ ${
							data.error || "Unexpected response."
						}`;
					}
				} catch {
					errorDiv.textContent = "❌ Error connecting to server.";
				}
			});

			// Message rendering
			function addMessage(sender, message) {
				const timestamp = new Date().toLocaleTimeString();
				const wrapper = document.createElement("div");
				wrapper.className =
					sender === "user"
						? "flex justify-end"
						: "flex justify-start";

				const bubble = document.createElement("div");
				bubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg shadow-md ${
					sender === "user"
						? "bg-blue-600 text-white"
						: "bg-gray-100 border"
				}`;

				bubble.innerHTML = `
    <p class="text-sm">${marked.parse(message)}</p>
    <p class="text-xs opacity-70 mt-1">${timestamp}</p>
`;

				wrapper.appendChild(bubble);
				chatHistoryDiv.appendChild(wrapper);
				chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
			}

			function renderChatHistory(history) {
				chatHistoryDiv.innerHTML = "";
				history.forEach((turn) => {
					if (turn.user) addMessage("user", turn.user);
					if (turn.assistant) addMessage("assistant", turn.assistant);
				});
			}
		</script>
	</body>
</html>
