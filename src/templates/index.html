    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Masvingo City Council RAG Assistant</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>
    <body class="bg-gradient-to-br from-blue-50 to-gray-100 min-h-screen flex items-center justify-center font-sans">
        <div class="w-full max-w-3xl h-[90vh] bg-white rounded-xl shadow-xl flex flex-col overflow-hidden">

            <!-- Header -->
            <header class="text-center p-4 border-b">
            <h1 class="text-2xl font-bold text-blue-700">Masvingo City Council RAG Assistant</h1>
            <p class="text-sm text-gray-600">Ask questions about council documents and get instant answers.</p>
            </header>

            <!-- Chat History -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            <!-- Messages will appear here -->
            </div>

            <!-- Error Message -->
            <div id="error" class="text-red-600 font-medium px-4" role="alert" aria-live="assertive"></div>

            <!-- Upload Toggle -->
            <div class="px-4 py-2">
            <button id="toggleUpload" class="text-sm text-green-600 hover:underline">Upload Document for increased knowledge base</button>
            </div>

            <!-- Upload Form -->
            <form id="upload-form" class="px-4 pb-4 hidden">
                <label for="file" class="block text-sm font-semibold text-gray-700 mb-2">Upload a new document (.txt):</label>
                <input type="file" id="file" name="file" accept=".txt" class="w-full mb-2 border rounded p-2" required />
                <button type="submit" class="w-full py-2 px-4 bg-green-600 text-white rounded hover:bg-green-700 transition">Upload</button>
                <div id="upload-status" class="mt-2 text-green-700 font-medium"></div>
            </form>

            <!-- Sticky Input Form -->
            <form id="query-form" class="bg-white p-4 border-t">
                <textarea id="question" name="question" rows="3" placeholder="Ask a question..." class="w-full p-3 border rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                <div class="flex justify-between items-center mt-2">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition">Ask</button>
                    <button type="button" id="previewBtn" class="text-sm text-blue-600 hover:underline">Preview</button>
                </div>
                <div id="previewArea" class="mt-2 p-2 bg-gray-100 rounded hidden"></div>
            </form>
        </div>

        <script>
            const form = document.getElementById("query-form");
            const questionInput = document.getElementById("question");
            const chatHistoryDiv = document.getElementById("chat-history");
            const errorDiv = document.getElementById("error");
            const uploadForm = document.getElementById("upload-form");
            const fileInput = document.getElementById("file");
            const uploadStatus = document.getElementById("upload-status");
            const previewBtn = document.getElementById("previewBtn");
            const previewArea = document.getElementById("previewArea");
            const toggleUpload = document.getElementById("toggleUpload");

            // Toggle upload panel
            toggleUpload.addEventListener("click", () => {
            uploadForm.classList.toggle("hidden");
            });

            // Markdown preview
            previewBtn.addEventListener("click", () => {
            previewArea.innerHTML = marked.parse(questionInput.value);
            previewArea.classList.toggle("hidden");
            });

            // Clear error on input
            questionInput.addEventListener("input", () => {
            errorDiv.textContent = "";
            });

            // Upload logic
            uploadForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            uploadStatus.textContent = "";
            errorDiv.textContent = "";
            const formData = new FormData(uploadForm);
            try {
                const response = await fetch("/upload", { method: "POST", body: formData });
                const data = await response.json();
                if (data.success) {
                uploadStatus.textContent = `✅ Uploaded: ${data.filename}`;
                fileInput.value = "";
                } else {
                errorDiv.textContent = `❌ ${data.error || "Unexpected response."}`;
                }
            } catch {
                errorDiv.textContent = "❌ Error uploading file.";
            }
            });

            // Ask logic
            form.addEventListener("submit", async (e) => {
            e.preventDefault();
            errorDiv.textContent = "";
            const formData = new FormData(form);
            const userMessage = questionInput.value.trim();
            if (userMessage) {
                addMessage("user", userMessage);
                questionInput.value = "";
                previewArea.classList.add("hidden");
            }
            try {
                const response = await fetch("/query", { method: "POST", body: formData });
                const data = await response.json();
                if (data.history) {
                renderChatHistory(data.history);
                } else if (data.answer) {
                addMessage("assistant", data.answer);
                } else {
                errorDiv.textContent = `❌ ${data.error || "Unexpected response."}`;
                }
            } catch {
                errorDiv.textContent = "❌ Error connecting to server.";
            }
            });

            // Message rendering
            function addMessage(sender, message) {
            const timestamp = new Date().toLocaleTimeString();
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3 " + (sender === "user" ? "justify-end" : "justify-start");

            const avatar = document.createElement("img");
            avatar.src = sender === "user" ? "https://ui-avatars.com/api/?name=You&background=0D8ABC&color=fff" : "https://ui-avatars.com/api/?name=Bot&background=gray&color=fff";
            avatar.alt = sender;
            avatar.className = "w-8 h-8 rounded-full";

            const bubble = document.createElement("div");
            bubble.className = `max-w-sm px-4 py-2 rounded-2xl shadow ${
                sender === "user" ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-800"
            }`;
            bubble.innerHTML = `<p class="text-sm">${marked.parse(message)}</p><p class="text-xs text-right mt-1 opacity-60">${timestamp}</p>`;

            if (sender === "user") {
                wrapper.appendChild(bubble);
                wrapper.appendChild(avatar);
            } else {
                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);
            }

            chatHistoryDiv.appendChild(wrapper);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            }

            function renderChatHistory(history) {
            chatHistoryDiv.innerHTML = "";
            history.forEach((turn) => {
                if (turn.user) addMessage("user", turn.user);
                if (turn.assistant) addMessage("assistant", turn.assistant);
            });
            }
        </script>
</html>
